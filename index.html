<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
    }
    .logo {
      display: flex;
      align-items: flex-start;
      margin-top: -6rem;
      margin-bottom: -3.5rem;
      margin-left: -1.2rem;
    }
    .logo img {
      height: 300px;
    }
    label, input, button {
      display: block;
      margin: 1rem 0 0.5rem;
    }
    .selector-container {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }
    .dimension-buttons, .tjocklek-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    .dimension-buttons button, .tjocklek-buttons button {
      padding: 0.3rem 0.6rem;
      background-color: #fff;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      min-width: 2.5rem;
      min-height: 1.8rem;
    }
    .dimension-buttons button.active, .tjocklek-buttons button.active {
      background-color: #444;
      color: #fff;
    }
    .dimension-buttons button.error, .tjocklek-buttons button.error {
      border: 2px solid red;
    }
    .result {
      margin-top: 2rem;
      white-space: pre-line;
    }
    .bold {
      font-weight: bold;
      text-decoration: underline;
    }
    .navigation-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
    }
    .warning {
      color: red;
      font-weight: bold;
      margin: 1rem 0;
    }
    .paket-knappar {
      display: inline-flex;
      gap: 0.5rem;
      margin-left: 1rem;
    }
    .paket-knappar button {
      padding: 0.2rem 0.6rem;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      background: #fff;
      color: #000;
      cursor: pointer;
    }
    .kund-rad {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

    #urHyvelSelect {
  padding: 0.3rem 0.6rem;
  font-size: 0.85rem;
  min-width: 2.5rem;
  min-height: 1.8rem;
  border-radius: 4px;
  border: none;
  background-color: #fff;
  color: #000;
  margin-bottom: 1rem;
}

    .knappgrupp {
  display: inline-flex;
  gap: 0.5rem;
  margin-left: 1rem;
}
.knappgrupp button {
  padding: 0.2rem 0.6rem;
  font-size: 1rem;
  font-weight: bold;
  border: none;
  border-radius: 4px;
  background: #fff;
  color: #000;
  cursor: pointer;
}

  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="Perssons logotyp" />
  </div>

  <label for="plank">Antal plank:</label>
  <input type="number" id="plank" />
  <div class="warning" id="varning"></div>

  <div class="selector-container">
    <div>
 
<!-- Först dropdownen som ligger ovanför hela raden -->
<label for="urHyvelSelect">Välj antal ur hyvel:</label>
<select id="urHyvelSelect">
  <option value="1" selected>1</option>
  <option value="2">2</option>
  <option value="3">3</option>
</select>

<!-- Nu horisontell rad där båda kolumnerna börjar på samma höjd -->
<div class="selector-container">
  <div>
    <label>Välj dimension:</label>
    <div class="dimension-buttons" id="dimension-buttons"></div>
  </div>
  <div>
    <label>Välj tjocklek:</label>
    <div class="tjocklek-buttons" id="tjocklek-buttons"></div>
  </div>
</div>


  <label>Brädor till kund(er):</label>
  <div class="kund-controls">
    <button onclick="laggTillKund()">+</button>
    <button onclick="taBortKund()">–</button>
  </div>
  <div id="kund-container"></div>

  <button onclick="berakna()">Beräkna</button>

  <div class="result" id="kundOut"></div>
  <div class="result" id="restOut"></div>

  <div class="navigation-buttons">
    <button onclick="visaForra()">Föregående paket</button>
    <button onclick="visaNasta()">Nästa paket</button>
  </div>

  <script>
    const bradorPerLager = { 4: 11, 5: 9, 6: 7, 7: 6, 8: 5, 9: 5 };
    let valdDimension = 0;
    let valdTjocklek = 0;
    let paketLista = [];
    let aktuellIndex = 0;
    let valUrHyvel = 1;
    


    const knappContainer = document.getElementById('dimension-buttons');
    [4,5,6,7,8,9].forEach(d => {
      const btn = document.createElement('button');
      btn.textContent = d;
      btn.onclick = () => {
        valdDimension = d;
        document.querySelectorAll('.dimension-buttons button').forEach(b => b.classList.remove("active", "error"));
        btn.classList.add("active");
      };
      knappContainer.appendChild(btn);
    });

    const tjocklekContainer = document.getElementById('tjocklek-buttons');
    [21, 28].forEach(t => {
      const btn = document.createElement('button');
      btn.textContent = t;
      btn.onclick = () => {
        valdTjocklek = t;
        document.querySelectorAll('.tjocklek-buttons button').forEach(b => b.classList.remove("active", "error"));
        btn.classList.add("active");
      };
      tjocklekContainer.appendChild(btn);
    });

    function laggTillKund() {
  const container = document.getElementById("kund-container");

  const rad = document.createElement("div");
  rad.className = "kund-rad";

  const input = document.createElement("input");
  input.type = "number";
  input.className = "kund-input";
  input.placeholder = "Antal brädor";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.className = "malas-checkbox";

  const label = document.createElement("label");
  label.textContent = "målas";
  label.style.marginLeft = "0.3rem";

  rad.appendChild(input);
  rad.appendChild(checkbox);
  rad.appendChild(label);

  container.appendChild(rad);
}



    function taBortKund() {
  const container = document.getElementById("kund-container");
  const rader = container.getElementsByClassName("kund-rad");
  if (rader.length > 0) {
    container.removeChild(rader[rader.length - 1]);
  }
}


    function jamnFodelning(totalLager, antalPak) {
      const bas = Math.floor(totalLager / antalPak);
      const extra = totalLager % antalPak;
      return Array.from({ length: antalPak }, (_, i) => bas + (i < extra ? 1 : 0));
    }

    function justeraPaket(kundNr, andring) {
      const bpl = bradorPerLager[valdDimension] * valUrHyvel;

      const paket = paketLista.filter(p => p.typ === 'kund' && p.kund == kundNr);
      const totalLag = paket.reduce((sum, p) => sum + p.lager, 0);
      let antal = paket.length + andring;
      if (antal < 1) return;
      const ny = jamnFodelning(totalLag, antal).map(l => ({ typ: 'kund', kund: parseInt(kundNr), lager: l, varde: l * bpl }));
      paketLista = paketLista.filter(p => !(p.typ === 'kund' && p.kund == kundNr)).concat(ny);
      visaPaket();
    }

    function justeraRest(andring) {
      const bpl = bradorPerLager[valdDimension] * valUrHyvel;

      const rest = paketLista.filter(p => p.typ === 'rest');
      const totalLag = rest.reduce((sum, p) => sum + p.lager, 0);
      let antal = rest.length + andring;
      if (antal < 1) return;
      const ny = jamnFodelning(totalLag, antal).map(l => ({ typ: 'rest', lager: l, varde: l * bpl }));
      paketLista = paketLista.filter(p => p.typ !== 'rest').concat(ny);
      visaPaket();
    }

    function paketfordelning(lager, minLager, maxLager) {
      if (lager < minLager) return [lager];
      for (let antal = 1; antal <= lager; antal++) {
        let bas = Math.floor(lager / antal);
        if (bas < minLager || bas > maxLager) continue;
        let lista = Array(antal).fill(bas);
        let extra = lager - bas * antal;
        for (let i = 0; i < lista.length && extra > 0; i++) {
          if (lista[i] < maxLager) {
            lista[i]++;
            extra--;
          }
        }
        if (extra === 0) return lista;
      }
      return [lager];
    }

    function berakna() {
      const kundOut = document.getElementById("kundOut");
      const restOut = document.getElementById("restOut");
      const varning = document.getElementById("varning");
      kundOut.textContent = "";
      restOut.textContent = "";
      varning.textContent = "";

      const plank = parseInt(document.getElementById("plank").value) || 0;
      const kundRader = document.querySelectorAll(".kund-rad");
const kundData = [];

kundRader.forEach(rad => {
  const input = rad.querySelector(".kund-input");
  const checkbox = rad.querySelector(".malas-checkbox");

  const antal = parseInt(input.value) || 0;
  if (antal > 0) {
    kundData.push({ antal: antal, mala: checkbox.checked });
  }
});

      if (!plank) {
        kundOut.textContent = "Fyll i antal plank.";
        return;
      }
      if (!valdDimension) {
        kundOut.textContent = "Välj en dimension.";
        document.querySelectorAll('.dimension-buttons button').forEach(b => b.classList.add("error"));
        return;
      }
      if (!valdTjocklek) {
        kundOut.textContent = "Välj en tjocklek.";
        document.querySelectorAll('.tjocklek-buttons button').forEach(b => b.classList.add("error"));
        return;
      }

      const bpl = bradorPerLager[valdDimension] * valUrHyvel;

      const totBrador = plank * valUrHyvel * 2;
      const [minLager, maxLager] = (valdTjocklek === 28) ? [12, 21] : [16, 28];

      paketLista = [];
      let totalKundBrador = 0;

      kundData.forEach((kund, kundIndex) => {
  const kundLager = Math.ceil(kund.antal / bpl);
  let lagerLista = paketfordelning(kundLager, minLager, maxLager);

  // Slå ihop två och två om checkboxen är ikryssad
  if (kund.mala) {
    const nyLista = [];
    for (let i = 0; i < lagerLista.length; i += 2) {
      if (i + 1 < lagerLista.length) {
        nyLista.push(lagerLista[i] + lagerLista[i + 1]);
      } else {
        nyLista.push(lagerLista[i]);
      }
    }
    lagerLista = nyLista;
  }

  lagerLista.forEach(l => {
    paketLista.push({ typ: 'kund', kund: kundIndex + 1, lager: l, varde: l * bpl });
  });

  totalKundBrador += lagerLista.reduce((sum, l) => sum + l * bpl, 0);
});


      let kvar = totBrador - totalKundBrador;

      if (kvar < 0) {
        varning.innerHTML = `❗ <b>Det saknas ${Math.abs(kvar / 2)} plank</b> för att täcka kundernas behov.`;
      }

      if (kvar > 0) {
        const restLager = Math.ceil(kvar / bpl);
        const restPak = paketfordelning(restLager, minLager, maxLager);
        restPak.forEach(l => {
          paketLista.push({ typ: 'rest', lager: l, varde: Math.min(l * bpl, kvar) });
          kvar -= l * bpl;
        });
      }

      aktuellIndex = 0;
      visaPaket();
    }

function visaPaket() {
  const kundOut = document.getElementById("kundOut");
  const restOut = document.getElementById("restOut");
  kundOut.textContent = "";
  restOut.textContent = "";

  const kunder = paketLista.filter(p => p.typ === 'kund').reduce((acc, p) => {
    if (!acc[p.kund]) acc[p.kund] = [];
    acc[p.kund].push(p);
    return acc;
  }, {});

  let kundText = "";
  for (const [kundNr, paket] of Object.entries(kunder)) {
    const totalBr = paket.reduce((sum, p) => sum + p.varde, 0);
    const totalLag = paket.reduce((sum, p) => sum + p.lager, 0);
    kundText += `Kund ${kundNr}:\n`;
    kundText += `Totalt ${totalLag} lager ⇒ ${paket.length} paket `;
kundText += `<span class="knappgrupp">
  <button onclick="justeraPaket(${kundNr}, -1)">–</button>
  <button onclick="justeraPaket(${kundNr}, 1)">+</button>
</span>\n`;


    const markeradLager = paket.map(p =>
      paketLista.indexOf(p) === aktuellIndex ? `<span class='bold'>${p.lager}</span>` : p.lager
    );

    const markeradBrador = paket.map(p =>
      paketLista.indexOf(p) === aktuellIndex ? `<span class='bold'>${p.varde}</span>` : p.varde
    );

    kundText += `  Lager: ${markeradLager.join(', ')}\n`;
    kundText += `  Brädor: ${markeradBrador.join(', ')}\n\n`;
  }

  const restPak = paketLista.filter(p => p.typ === 'rest');
  let restText = "";
  if (restPak.length) {
const totalRestLager = restPak.reduce((sum, p) => sum + p.lager, 0);
restText += `Resterande paket:\n`;
restText += `Totalt ${totalRestLager} lager ⇒ ${restPak.length} paket `;
restText += `<span class="knappgrupp">
  <button onclick="justeraRest(-1)">–</button>
  <button onclick="justeraRest(1)">+</button>
</span>\n`;

const markeradLager = restPak.map(p =>
  paketLista.indexOf(p) === aktuellIndex ? `<span class='bold'>${p.lager}</span>` : p.lager
);

const markeradBrador = restPak.map(p =>
  paketLista.indexOf(p) === aktuellIndex ? `<span class='bold'>${p.varde}</span>` : p.varde
);

restText += `  Lager: ${markeradLager.join(', ')}\n`;
restText += `  Brädor: ${markeradBrador.join(', ')}`;

  }

  kundOut.innerHTML = kundText;
  restOut.innerHTML = restText;
}


    function visaNasta() {
      if (aktuellIndex < paketLista.length - 1) {
        aktuellIndex++;
        visaPaket();
      }
    }

    function visaForra() {
      if (aktuellIndex > 0) {
        aktuellIndex--;
        visaPaket();
      }
    }

    window.onload = () => {
      document.getElementById("urHyvelSelect").addEventListener("change", e => {
  valUrHyvel = parseInt(e.target.value);
});

      laggTillKund();
    };
  </script>
</body>
</html>
